<!DOCTYPE html>
<html>
<head>
    <title>FCM Background Test</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging-compat.js"></script>
</head>
<body>
    <h1>FCM Background Message Test</h1>
    <button id="sendTest">Send FCM Test Message</button>
    <div id="instructions">
        <h3>Instructions:</h3>
        <ol>
            <li>Click "Send FCM Test Message"</li>
            <li>Immediately minimize this browser tab or switch to another app</li>
            <li>Wait 5 seconds</li>
            <li>Check if you received a system notification</li>
        </ol>
    </div>
    <div id="logs"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCF_hn_33xTJaO-zwXGNxhVc9yJqjXfXD0",
            authDomain: "sniket-d2766.firebaseapp.com",
            projectId: "sniket-d2766",
            storageBucket: "sniket-d2766.firebasestorage.app",
            messagingSenderId: "968429297305",
            appId: "1:968429297305:web:7425601aff7e7d08b52208",
            measurementId: "G-V3D17BJYZ9"
        };

        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        function log(message) {
            const logs = document.getElementById('logs');
            logs.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        // Register service worker
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then(registration => {
                log('âœ… Service worker registered');
                messaging.useServiceWorker(registration);
                return messaging.getToken();
            })
            .then(token => {
                log('âœ… FCM token received: ' + token.substring(0, 20) + '...');
                window.fcmToken = token;
            })
            .catch(err => {
                log('âŒ Error: ' + err);
            });

        document.getElementById('sendTest').addEventListener('click', async () => {
            if (!window.fcmToken) {
                log('âŒ No FCM token available');
                return;
            }

            log('ðŸš€ Sending data-only FCM message...');
            log('âš ï¸ MINIMIZE this browser tab NOW to test background notifications!');

            try {
                const response = await fetch('/api/fcm/send-data-only', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: '6881370e00267202519b',
                        userType: 'customer',
                        title: 'Background Test',
                        body: 'If you see this as a system notification, it works!',
                        data: {
                            type: 'message',
                            category: 'test',
                            priority: 'normal'
                        },
                        action: {
                            type: 'message',
                            id: 'test-background-' + Date.now()
                        }
                    })
                });

                const result = await response.json();
                log('ðŸ“Š FCM Result: ' + JSON.stringify(result));
            } catch (error) {
                log('âŒ Error sending FCM: ' + error);
            }
        });

        // Listen for foreground messages
        messaging.onMessage((payload) => {
            log('ðŸ“¨ Foreground message received: ' + JSON.stringify(payload));
        });
    </script>
</body>
</html>
